# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a **monorepo development environment** for the Conestack organization, which develops a collection of interrelated Python packages. The repository uses **mxdev/mxmake** to manage development of 50+ packages simultaneously.

### Package Families

The codebase consists of three main package families:

1. **node.*** - Tree/node data structure libraries (foundation layer)
   - `node` - Core tree data structures using ordered dictionaries
   - `node.ext.directory`, `node.ext.fs`, `node.ext.ldap`, `node.ext.ugm`, `node.ext.yaml`, `node.ext.zodb` - Extensions for various backends

2. **yafowil.*** - Form library and widgets
   - `yafowil` - Yet Another Form Widget Library (core)
   - `yafowil.bootstrap` - Bootstrap integration
   - `yafowil.widget.*` - Widget extensions (ace, array, autocomplete, chosen, color, cron, datetime, dict, dynatree, image, location, multiselect, richtext, select2, slider, tiptap, wysihtml5)

3. **cone.*** - Web application framework built on Pyramid
   - `cone.app` - Main web application framework
   - `cone.tile` - Tile composition system
   - `cone.ugm` - User/Group management
   - `cone.ldap`, `cone.sql`, `cone.zodb` - Backend integrations
   - `cone.calendar`, `cone.charts`, `cone.fileupload`, `cone.firebase`, `cone.maps`, `cone.tokens` - Feature packages

**Supporting packages:** `odict`, `plumber`, `webresource`, `treibstoff`, `mxdev`, `mxmake`

### Directory Structure

- `sources/` - All package source code (checked out from individual Git repos via mxdev)
- `mx.ini` - Configuration file defining all package repositories and build settings
- `Makefile` - Generated by mxmake; provides build/test/install targets
- `venv/` - Python virtual environment
- `openldap/` - Locally built OpenLDAP server (required for LDAP-related tests)
- `.mxmake/` - Build system artifacts and generated scripts

**Important:** Some packages in `sources/` may contain their own nested mxmake setup (with their own `sources/`, `venv/`, etc.) if they were developed standalone. When working from the root conestack directory, **ignore these nested structures** - they are for standalone development of individual packages. Only the root-level directories matter for monorepo development.

## Common Commands

### Initial Setup

```bash
# Install system dependencies (Debian/Ubuntu)
make system-dependencies

# Full project install (creates venv, checks out sources, installs packages)
make install

# Or step by step:
make mxenv        # Create virtual environment
make sources      # Checkout all source repositories
make mxfiles      # Generate dependency files
make packages     # Install all packages
```

### Testing

```bash
# Run all tests across all packages
make test

# Run coverage
make coverage
```

The test runner uses **zope.testrunner** and runs tests from all packages defined in mx.ini. Tests requiring LDAP functionality need the OpenLDAP installation (built via `make openldap`).

### Building Documentation

```bash
# Build documentation (uses Sphinx)
cd docs
make html
```

### Cleanup

```bash
# Clean build artifacts (keeps sources)
make clean

# Remove sources directory too
make purge

# Or clean specific components
make mxenv-clean      # Remove virtual environment
make packages-clean   # Uninstall packages
make sources-purge    # Remove checked out sources
```

### Working with Sources

```bash
# Re-checkout sources after mx.ini changes
make sources-dirty
make sources

# Reinstall packages after source changes
make packages-dirty
make packages
```

## Build System Architecture

This project uses **mxmake** (managed multi-repository make) with **mxdev** (managed development tool):

- **mx.ini** defines all repositories, branches, and build configuration
- **mxdev** checks out sources from GitHub and generates requirements files
- **mxmake** generates the Makefile with orchestrated build targets
- Virtual environment uses **uv** as the package installer (faster than pip)

### Environment Variables

The test runner sets these environment variables (defined in mx.ini):

- `TESTRUN_MARKER=1`
- `LDAP_ADD_BIN=openldap/bin/ldapadd`
- `LDAP_DELETE_BIN=openldap/bin/ldapdelete`
- `SLAPD_BIN=openldap/libexec/slapd`
- `SLAPD_URIS=ldap://127.0.0.1:12345`

## Package Structure Convention

All packages follow a consistent structure:

```
package-name/
├── src/
│   └── namespace/
│       └── package/
│           ├── __init__.py
│           ├── (implementation files)
│           └── tests/
├── setup.py or setup.cfg
└── README.rst
```

Most packages use namespace packages (e.g., `cone.app` has code in `src/cone/app/`).

## Python Version

Minimum Python version: **3.7** (configured in Makefile)
Currently using Python 3.11 (see `.python-version`)

## Working with Individual Packages

Each package in `sources/` is its own Git repository. To work on a specific package:

1. Changes made in `sources/package-name/` affect that package's repository
2. Use Git commands inside the specific package directory
3. The package is installed in development mode (editable install)
4. The root mx.ini defines which branch each package uses

## Key Configuration Files

- **mx.ini** - Package repository configuration, build settings, test paths
- **Makefile** - Generated build orchestration (Generated, only edited settings are kept)
